version: '3.8'

services:
  # Backend API (Production)
  backend:
    build: 
      context: ./backend
      target: production
    environment:
      - DATABASE_URL=sqlite:///app/database/anthonys_musings.db
      - DEBUG=false
      - CORS_ORIGINS=https://anthonys-musings.com,https://www.anthonys-musings.com
      - SECRET_KEY=${SECRET_KEY}
      - MAX_CONTENT_LENGTH=10000000
      - EXPLICIT_CONTENT_WARNING=true
    volumes:
      - database_data:/app/database
    networks:
      - anthonys-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend Web Interface (Production)
  frontend:
    build:
      context: ./frontend
      target: production
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - backend
    environment:
      - API_BASE_URL=http://backend:8000
      - NODE_ENV=production
    networks:
      - anthonys-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Redis for caching (optional)
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - anthonys-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Database backup service
  backup:
    image: alpine:latest
    volumes:
      - database_data:/data:ro
      - backup_data:/backup
    environment:
      - BACKUP_DIR=/backup
      - DATA_DIR=/data
      - BACKUP_SCHEDULE=${BACKUP_SCHEDULE:-0 2 * * *}
    command: |
      sh -c '
        apk add --no-cache dcron sqlite
        echo "$${BACKUP_SCHEDULE} /usr/local/bin/backup.sh" | crontab -
        cat > /usr/local/bin/backup.sh << EOF
        #!/bin/sh
        DATE=$$(date +%Y%m%d_%H%M%S)
        mkdir -p $${BACKUP_DIR}
        cp $${DATA_DIR}/anthonys_musings.db $${BACKUP_DIR}/anthonys_musings_$${DATE}.db
        sqlite3 $${BACKUP_DIR}/anthonys_musings_$${DATE}.db "VACUUM;"
        find $${BACKUP_DIR} -name "anthonys_musings_*.db" -mtime +30 -delete
        echo "Backup completed: anthonys_musings_$${DATE}.db"
        EOF
        chmod +x /usr/local/bin/backup.sh
        crond -f
      '
    networks:
      - anthonys-network
    restart: unless-stopped

networks:
  anthonys-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16

volumes:
  database_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATABASE_VOLUME_PATH:-./data/database}
  backup_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${BACKUP_VOLUME_PATH:-./data/backups}
  redis_data:
    driver: local
  nginx_logs:
    driver: local
